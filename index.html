<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #000;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal backdrop styling */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        /* Modal content styling */
        .modal-content {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            max-width: 95%;
            max-height: 95%;
            overflow-y: auto;
            position: relative;
        }
        @media (min-width: 640px) {
            .modal-content {
                padding: 2rem;
                max-width: 90%;
                max-height: 90%;
            }
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
        }
        .collapsible-content.expanded {
            max-height: 1000px; /* Increased max-height to accommodate new section */
            padding-top: 1rem;
        }
        .collapsible-header .chevron {
            transition: transform 0.3s ease;
        }
        .collapsible-header.expanded .chevron {
            transform: rotate(180deg);
        }
        #back-to-top-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 40;
        }
        #back-to-top-btn.show {
            opacity: 1;
            visibility: visible;
        }
        /* Pulse animation for low stock alerts section */
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <!-- Header Section -->
    <header class="text-center mb-6 sm:mb-12">
        <h1 class="text-3xl sm:text-5xl font-bold text-gray-900 mb-2">Airtable Viewer</h1>
        <p class="text-md sm:text-lg text-gray-600">Viewing Data from Airtable</p>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto space-y-6 sm:space-y-12">
        
        <!-- Search and Filter Section -->
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div class="sm:flex sm:flex-row sm:gap-6 sm:items-center">
                <input type="search" id="search-input" placeholder="Search machines..."
                       class="w-full sm:flex-grow px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                <div class="mt-4 sm:mt-0 w-full sm:w-auto">
                    <button id="toggle-filters-btn" class="w-full sm:hidden px-4 py-2 bg-gray-200 rounded-lg font-semibold text-gray-700 hover:bg-gray-300 transition-colors">
                        Show Filters
                    </button>
                    <select id="status-filter" class="hidden sm:block w-full px-4 py-2 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                        <option value="">All Statuses</option>
                        <option value="Operational">Operational</option>
                        <option value="Under Maintenance">Under Maintenance</option>
                        <option value="Out of Service">Out of Service</option>
                        <option value="Decommissioned">Decommissioned</option>
                    </select>
                </div>
            </div>
            
            <!-- Collapsible filter content for mobile -->
            <div id="collapsible-filter-content" class="collapsible-content sm:hidden">
                <select id="status-filter-mobile" class="w-full mt-4 px-4 py-2 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                    <option value="">All Statuses</option>
                    <option value="Operational">Operational</option>
                    <option value="Under Maintenance">Under Maintenance</option>
                    <option value="Out of Service">Out of Service</option>
                    <option value="Decommissioned">Decommissioned</option>
                </select>
            </div>
        </div>

        <!-- Low Stock Alerts Section -->
        <section id="low-stock-alerts-container" class="bg-red-50 p-4 sm:p-6 rounded-xl shadow-lg hidden">
            <h2 class="text-2xl font-bold text-red-700 mb-4 flex items-center">
                Low Stock Alerts
            </h2>
            <div id="low-stock-list" class="space-y-3">
                <!-- Low stock alerts will be inserted here -->
            </div>
        </section>

        <!-- Machines Section -->
        <section class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2 sm:mb-0">Machines</h2>
                <div class="flex space-x-2">
                    <button id="expand-all-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors text-sm">
                        Expand All
                    </button>
                    <button id="collapse-all-btn" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-colors text-sm">
                        Collapse All
                    </button>
                </div>
            </div>
            <div id="machines-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Loading spinner for machines -->
                <div class="col-span-full flex flex-col items-center justify-center py-10">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-500">Loading Machines...</p>
                </div>
            </div>
            <div id="load-more-container" class="flex justify-center mt-6 hidden">
                <button id="load-more-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                    Load More
                </button>
            </div>
        </section>
    </main>

    <!-- Consumables Modal -->
    <div id="consumables-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6">
                <h2 id="consumables-modal-title" class="text-xl sm:text-3xl font-bold text-gray-900 mb-2 sm:mb-0">Consumables</h2>
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <input type="search" id="consumable-search-input" placeholder="Search consumables..."
                           class="w-full px-3 py-1 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <button id="close-consumables-modal-btn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl sm:text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Consumables table for desktop -->
            <div id="consumables-table-wrapper" class="hidden sm:block overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Name')">Name <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Consumable ID')">Consumable ID <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Cost/Unit')">Cost/Unit <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Unit')">Unit <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Stock Status')">Stock Status <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Reorder Point')">Reorder Point <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Current Stock')">Current Stock <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortConsumables('Location')">Location <i class="fas fa-sort ml-1"></i></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link</th>
                        </tr>
                    </thead>
                    <tbody id="modal-consumables-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Consumable table rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Consumables card view for mobile -->
            <div id="consumables-card-view" class="block sm:hidden space-y-4 mt-4">
                <!-- Consumable cards will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Maintenance Logs Modal -->
    <div id="maintenance-logs-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6">
                <h2 id="maintenance-logs-modal-title" class="text-xl sm:text-3xl font-bold text-gray-900 mb-2 sm:mb-0">Maintenance Logs</h2>
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <input type="search" id="maintenance-log-search-input" placeholder="Search logs..."
                           class="w-full px-3 py-1 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <button id="close-maintenance-logs-modal-btn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl sm:text-2xl"></i>
                    </button>
                </div>
            </div>
            <div id="maintenance-logs-container" class="space-y-4">
                <!-- Maintenance log cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Back to top button -->
    <button id="back-to-top-btn" class="p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <i class="fas fa-chevron-up"></i>
    </button>

    <script>
        // Airtable configuration
        const airtableConfig = {
            apiKey: 'patA8WihRZtwXarV8.d6d00c7b162757fb1b30efe56d8b58f8dbbbbb9f058e52a22fcde00e566b9956', 
            baseId: 'appOKqcWBsHytL5Ae', 
        };
        const BASE_URL = `https://api.airtable.com/v0/${airtableConfig.baseId}/`;
        
        let dataCache = {};
        let machinesData = [];
        let consumablesData = [];
        let maintenanceLogsData = [];
        let expandedCards = new Set();
        let currentModalConsumables = [];
        let currentModalMaintenanceLogs = [];
        let sortState = {
            field: 'Name',
            direction: 'asc'
        };
        let machinesToRenderCount = 10; // For simulated lazy loading

        // Utility function to fetch data from a table with exponential backoff
        async function fetchAirtableData(tableName, retries = 3, delay = 1000) {
            try {
                const response = await fetch(`${BASE_URL}${encodeURIComponent(tableName)}`, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                data.records.forEach(record => {
                    dataCache[record.id] = record.fields;
                });

                return data.records;

            } catch (error) {
                if (retries > 0 && error.message.includes('status: 429')) {
                    console.warn(`Rate limit hit for ${tableName}. Retrying in ${delay / 1000}s...`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchAirtableData(tableName, retries - 1, delay * 2);
                }
                console.error(`Could not fetch data from ${tableName}:`, error);
                const container = document.getElementById(getContainerId(tableName));
                if (container) {
                     container.innerHTML = `<p class="text-red-500 col-span-full text-center">Failed to load data for **${tableName}**. Please check the API key, table name, and network connection.</p>`;
                }
                return [];
            }
        }

        function getContainerId(tableName) {
            if (tableName === 'Machines') return 'machines-container';
            if (tableName === 'BSV 100 Consumables') return 'modal-consumables-table-body';
            return '';
        }
        
        /**
         * Helper function to format a date string into a human-readable format.
         * @param {string} dateString - The date string to format.
         * @returns {string} The formatted date string or 'N/A' if invalid.
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return 'N/A';
            }
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        /**
         * Toggles the expanded state of a single machine card.
         * @param {string} recordId - The ID of the machine record to toggle.
         */
        function toggleCardExpanded(recordId) {
            if (expandedCards.has(recordId)) {
                expandedCards.delete(recordId);
            } else {
                expandedCards.add(recordId);
            }
            localStorage.setItem('expandedCards', JSON.stringify([...expandedCards]));
            filterAndRender();
        }
        
        /**
         * Renders the cards for machines.
         * @param {Array} records - The list of Airtable records to render.
         * @param {string} containerId - The ID of the HTML element to render the cards in.
         */
        function renderMachineCards(records, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            
            const recordsToRender = records.slice(0, machinesToRenderCount);
            
            if (recordsToRender.length === 0) {
                container.innerHTML = `<p class="text-gray-500 col-span-full text-center">No machines found.</p>`;
                return;
            }
            
            // The list of fields to display on the machine cards.
            const machineFieldOrder = [
                'Manufacturer', 'Model', 'Serial Number', 'Part Number', 
                'Equipment Number', 'Year'
            ];
            
            recordsToRender.forEach(record => {
                const fields = record.fields;
                const recordId = record.id;
                const card = document.createElement('div');
                card.id = `card-${recordId}`;
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 flex flex-col';
                
                let statusBadge = '';
                const machineStatus = fields['Machine Status'];
                if (machineStatus === 'Under Maintenance') {
                    card.classList.add('bg-yellow-100');
                    statusBadge = `<span class="bg-yellow-300 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded-full"><i class="fas fa-wrench mr-1"></i> ${machineStatus}</span>`;
                } else if (machineStatus === 'Out of Service') {
                    card.classList.add('bg-red-100');
                    statusBadge = `<span class="bg-red-300 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded-full"><i class="fas fa-triangle-exclamation mr-1"></i> ${machineStatus}</span>`;
                } else if (machineStatus === 'Operational') {
                     statusBadge = `<span class="bg-green-300 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full"><i class="fas fa-circle-check mr-1"></i> ${machineStatus}</span>`;
                } else if (machineStatus === 'Decommissioned') {
                    card.classList.add('bg-gray-300');
                    statusBadge = `<span class="bg-gray-400 text-gray-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">💀 ${machineStatus}</span>`;
                } else {
                    card.classList.add('bg-white');
                }
                
                let cardHtml = '';
                const cardTitle = fields['Machine ID'];
                
                // Card header with click handler
                cardHtml += `
                    <div class="flex justify-between items-center pb-2 cursor-pointer" onclick="toggleCardExpanded('${recordId}')">
                        <h3 class="text-lg sm:text-xl font-medium text-gray-900">${cardTitle || 'Untitled Machine'}</h3>
                        <div class="flex items-center space-x-2">
                            ${statusBadge}
                            <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200 ${expandedCards.has(recordId) ? 'rotate-180' : ''}"></i>
                        </div>
                    </div>
                `;

                if (expandedCards.has(recordId)) {
                    // Expanded view
                    cardHtml += `<div class="mt-2 space-y-1">`;
                    machineFieldOrder.forEach(fieldName => {
                        let fieldValue = fields[fieldName];
                        
                        if (fieldName === 'Consumables' || fieldName === 'Machine Status' || fieldName === 'Machine ID') {
                            return;
                        }
                        
                        let fieldClass = 'text-gray-600';
                        let formattedValue = fieldValue || 'N/A';
                        
                        if (Array.isArray(fieldValue)) {
                            let displayValue = fieldValue.map(id => {
                                const linkedRecord = dataCache[id];
                                return linkedRecord ? (linkedRecord['Name'] || linkedRecord['Part Number'] || id) : id;
                            }).join(', ');
                            formattedValue = displayValue;
                        } 
                        cardHtml += `<p class="${fieldClass}"><span class="font-semibold">${fieldName}:</span> ${formattedValue}</p>`;
                    });

                    cardHtml += `
                        <div class="mt-4 flex flex-col space-y-2">
                            <a href="#" class="text-blue-600 hover:underline font-semibold" onclick="displayMaintenanceLogsForMachine('${record.id}'); return false;">View Maintenance Logs</a>
                    `;
                    if (fields['Consumables']) {
                        cardHtml += `
                            <a href="#" class="text-blue-600 hover:underline font-semibold" onclick="displayConsumablesForMachine('${record.id}'); return false;">View Consumables</a>
                        `;
                    }
                    cardHtml += `
                        </div>
                    `;
                }
                
                cardHtml += `</div>`;
                
                if (cardHtml) {
                    card.innerHTML = cardHtml;
                } else {
                    card.innerHTML = `<p class="text-gray-500">No data available for this record.</p>`;
                }
                
                container.appendChild(card);
            });
            
            // Show/hide the "Load More" button
            const loadMoreBtnContainer = document.getElementById('load-more-container');
            if (records.length > machinesToRenderCount) {
                loadMoreBtnContainer.classList.remove('hidden');
            } else {
                loadMoreBtnContainer.classList.add('hidden');
            }
        }
        
        /**
         * Renders the consumable records as table rows inside the modal for desktop.
         * @param {Array} records - The list of Airtable records to render.
         * @param {string} containerId - The ID of the HTML element to render the rows in.
         */
        function renderConsumableTable(records, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            if (records.length === 0) {
                container.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-4">No consumables found.</td></tr>`;
                return;
            }
            
            records.forEach(record => {
                const fields = record.fields;
                const row = document.createElement('tr');
                let rowClass = 'hover:bg-gray-100 transition-colors duration-200';
                
                const stockStatus = fields['Stock Status'];
                if (stockStatus === 'Low Stock') {
                    rowClass += ' bg-red-100 text-red-900';
                } else {
                    rowClass += ' bg-white text-gray-800';
                }
                
                row.className = rowClass;
                
                let costValue = fields['Cost/Unit'];
                let formattedCost = costValue !== undefined ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(costValue) : 'N/A';
                
                const linkValue = fields['Link'];
                const formattedLink = linkValue ? `<a href="${linkValue}" target="_blank" class="text-blue-600 hover:underline">View Link</a>` : 'N/A';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fields['Name'] || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fields['Consumable ID'] || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${formattedCost}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fields['Unit'] || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${stockStatus || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fields['Reorder Point'] !== undefined ? fields['Reorder Point'] : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fields['Current Stock'] !== undefined ? fields['Current Stock'] : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${fields['Location'] || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${formattedLink}</td>
                `;
                container.appendChild(row);
            });
        }
        
        /**
         * Renders the consumable records as cards inside the modal for mobile.
         * @param {Array} records - The list of Airtable records to render.
         * @param {string} containerId - The ID of the HTML element to render the cards in.
         */
        function renderConsumableCardsMobile(records, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            if (records.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">No consumables found.</p>`;
                return;
            }

            records.forEach(record => {
                const fields = record.fields;
                const card = document.createElement('div');
                let cardClass = 'p-4 rounded-lg shadow-sm';
                
                const stockStatus = fields['Stock Status'];
                if (stockStatus === 'Low Stock') {
                    cardClass += ' bg-red-100 text-red-900';
                } else {
                    cardClass += ' bg-gray-50 text-gray-800';
                }
                
                card.className = cardClass;
                
                let costValue = fields['Cost/Unit'];
                let formattedCost = costValue !== undefined ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(costValue) : 'N/A';
                const linkValue = fields['Link'];
                const formattedLink = linkValue ? `<a href="${linkValue}" target="_blank" class="text-blue-600 hover:underline">View Link</a>` : 'N/A';

                card.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${fields['Name'] || 'N/A'}</h4>
                    <p><span class="font-semibold">Consumable ID:</span> ${fields['Consumable ID'] || 'N/A'}</p>
                    <p><span class="font-semibold">Cost/Unit:</span> ${formattedCost}</p>
                    <p><span class="font-semibold">Unit:</span> ${fields['Unit'] || 'N/A'}</p>
                    <p><span class="font-semibold">Stock Status:</span> ${stockStatus || 'N/A'}</p>
                    <p><span class="font-semibold">Current Stock:</span> ${fields['Current Stock'] !== undefined ? fields['Current Stock'] : 'N/A'}</p>
                    <p><span class="font-semibold">Reorder Point:</span> ${fields['Reorder Point'] !== undefined ? fields['Reorder Point'] : 'N/A'}</p>
                    <p><span class="font-semibold">Location:</span> ${fields['Location'] || 'N/A'}</p>
                    <p class="mt-2"><span class="font-semibold">Link:</span> ${formattedLink}</p>
                `;
                container.appendChild(card);
            });
        }
        
        /**
         * Sorts the consumables data in the modal based on a field.
         * @param {string} field - The field to sort by.
         */
        function sortConsumables(field) {
            if (sortState.field === field) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.field = field;
                sortState.direction = 'asc';
            }

            const numericFields = ['Cost/Unit', 'Reorder Point', 'Current Stock'];
            const isNumeric = numericFields.includes(field);

            currentModalConsumables.sort((a, b) => {
                let aVal = a.fields[field];
                let bVal = b.fields[field];

                if (isNumeric) {
                    aVal = aVal !== undefined ? aVal : (sortState.direction === 'asc' ? Infinity : -Infinity);
                    bVal = bVal !== undefined ? bVal : (sortState.direction === 'asc' ? Infinity : -Infinity);
                    return sortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                } else { // String sort
                    aVal = aVal || '';
                    bVal = bVal || '';
                    return sortState.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
            });

            const consumableSearchQuery = document.getElementById('consumable-search-input').value.toLowerCase();
            const filteredConsumables = consumableSearchQuery 
                ? currentModalConsumables.filter(record => {
                    const fields = record.fields;
                    for (const key in fields) {
                        const value = fields[key];
                        if (value !== null && value !== undefined) {
                            if (String(value).toLowerCase().includes(consumableSearchQuery)) {
                                return true;
                            }
                        }
                    }
                    return false;
                })
                : currentModalConsumables;
            
            // Check screen size to render the appropriate view
            if (window.innerWidth >= 640) {
                renderConsumableTable(filteredConsumables, 'modal-consumables-table-body');
            } else {
                renderConsumableCardsMobile(filteredConsumables, 'consumables-card-view');
            }
        }

        /**
         * Renders the maintenance logs in the modal.
         * @param {Array} records - The list of maintenance log records.
         * @param {string} containerId - The ID of the HTML element to render the logs in.
         */
        function renderMaintenanceLogs(records, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">No maintenance logs found.</p>`;
                return;
            }
            
            records.forEach(record => {
                const fields = record.fields;
                const logCard = document.createElement('div');
                
                const consumableId = fields['Consumable Part'] ? fields['Consumable Part'][0] : null;
                const consumableName = consumableId ? dataCache[consumableId]?.Name || 'Unknown Consumable' : 'N/A';
                
                const lastReplaced = formatDate(fields['Last Replaced']);
                const nextServiceDue = formatDate(fields['Next Service Due']);
                
                let statusText = 'On Schedule';
                let statusClass = 'text-green-600';
                
                const today = new Date();
                if (fields['Next Service Due']) {
                    const nextServiceDate = new Date(fields['Next Service Due']);
                    if (nextServiceDate < today) {
                        statusText = '⚠️ Overdue';
                        statusClass = 'text-red-600 font-semibold';
                    }
                }
                
                logCard.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                logCard.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${consumableName}</h4>
                    <p class="text-sm"><span class="font-semibold">Last Replaced:</span> ${lastReplaced}</p>
                    <p class="text-sm"><span class="font-semibold">Next Service Due:</span> ${nextServiceDue}</p>
                    <p class="text-sm"><span class="font-semibold">Status:</span> <span class="${statusClass}">${statusText}</span></p>
                `;
                
                container.appendChild(logCard);
            });
        }


        /**
         * Renders the low stock alerts on the main page.
         */
        function renderLowStockAlerts() {
            const lowStockItems = consumablesData.filter(c => {
                const stock = c.fields['Current Stock'];
                const reorder = c.fields['Reorder Point'];
                return typeof stock === 'number' && typeof reorder === 'number' && stock <= reorder;
            });

            const container = document.getElementById('low-stock-list');
            const alertsSection = document.getElementById('low-stock-alerts-container');

            if (lowStockItems.length > 0) {
                alertsSection.classList.remove('hidden');
                alertsSection.classList.add('pulse-animation');
                container.innerHTML = '';
                lowStockItems.forEach(item => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'flex items-center text-red-700 p-2 rounded-md bg-red-100 shadow-inner';
                    alertDiv.innerHTML = `<p><strong>${item.fields['Name']}</strong> is at <strong>${item.fields['Current Stock']}</strong> units (Reorder Point: ${item.fields['Reorder Point']})</p>`;
                    container.appendChild(alertDiv);
                });
            } else {
                alertsSection.classList.add('hidden');
                alertsSection.classList.remove('pulse-animation');
            }
        }

        /**
         * Shows the consumables modal.
         * @param {string} title - The title for the modal.
         * @param {Array} records - The records to display in the modal.
         */
        function showConsumablesModal(title, records) {
            const modal = document.getElementById('consumables-modal');
            const modalTitle = document.getElementById('consumables-modal-title');
            
            modalTitle.textContent = title;
            currentModalConsumables = records;
            sortConsumables('Name'); // Default sort by name
            modal.classList.remove('hidden');
        }
        
        /**
         * Shows the maintenance logs modal.
         * @param {string} title - The title for the modal.
         * @param {Array} records - The records to display in the modal.
         */
        function showMaintenanceLogsModal(title, records) {
            const modal = document.getElementById('maintenance-logs-modal');
            const modalTitle = document.getElementById('maintenance-logs-modal-title');
            
            modalTitle.textContent = title;
            currentModalMaintenanceLogs = records;
            renderMaintenanceLogs(records, 'maintenance-logs-container');
            modal.classList.remove('hidden');
        }

        /**
         * Hides the consumables modal.
         */
        function hideConsumablesModal() {
            const modal = document.getElementById('consumables-modal');
            modal.classList.add('hidden');
            // Clear the consumable search bar when the modal closes
            document.getElementById('consumable-search-input').value = '';
            filterAndRender(); 
        }
        
        /**
         * Hides the maintenance logs modal.
         */
        function hideMaintenanceLogsModal() {
            const modal = document.getElementById('maintenance-logs-modal');
            modal.classList.add('hidden');
            document.getElementById('maintenance-log-search-input').value = '';
            filterAndRender();
        }

        /**
         * Filters the consumables and displays them for a specific machine inside a modal.
         * @param {string} machineRecordId - The ID of the machine record.
         */
        function displayConsumablesForMachine(machineRecordId) {
            const machineRecord = dataCache[machineRecordId];
            if (!machineRecord || !machineRecord['Consumables']) {
                const consumablesTableBody = document.getElementById('modal-consumables-table-body');
                const consumablesCardView = document.getElementById('consumables-card-view');
                if (consumablesTableBody) {
                    consumablesTableBody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-4">No consumables found for this machine.</td></tr>`;
                }
                if (consumablesCardView) {
                     consumablesCardView.innerHTML = `<p class="text-center text-gray-500 py-4">No consumables found for this machine.</p>`;
                }
                const title = `Consumables for ${machineRecord ? machineRecord['Machine ID'] : 'Unknown Machine'}`;
                showConsumablesModal(title, []);
                return;
            }
            
            const consumableIds = machineRecord['Consumables'];
            const filteredConsumables = consumablesData.filter(c => consumableIds.includes(c.id));
            
            const title = `Consumables for ${machineRecord['Machine ID']}`;
            showConsumablesModal(title, filteredConsumables);
        }
        
        /**
         * Filters the maintenance logs and displays them for a specific machine inside a modal.
         * @param {string} machineRecordId - The ID of the machine record.
         */
        function displayMaintenanceLogsForMachine(machineRecordId) {
            const machineRecord = dataCache[machineRecordId];
            if (!machineRecord) {
                showMaintenanceLogsModal('Maintenance Logs for Unknown Machine', []);
                return;
            }
            
            const logsForMachine = maintenanceLogsData.filter(log => {
                const linkedMachineIds = log.fields['Machine'];
                return linkedMachineIds && linkedMachineIds.includes(machineRecordId);
            });
            
            const title = `Maintenance Logs for ${machineRecord['Machine ID']}`;
            showMaintenanceLogsModal(title, logsForMachine);
        }
        
        /**
         * Function to handle filtering for machines and consumables based on search/status.
         */
        function filterAndRender() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            
            const isMobile = window.innerWidth < 640;
            const statusFilterElement = isMobile ? document.getElementById('status-filter-mobile') : document.getElementById('status-filter');
            const statusFilter = statusFilterElement.value;
            
            const consumableSearchQuery = document.getElementById('consumable-search-input').value.toLowerCase();
            const logSearchQuery = document.getElementById('maintenance-log-search-input').value.toLowerCase();
            
            // Filter machines
            let filteredMachines = machinesData;
            if (searchQuery) {
                filteredMachines = filteredMachines.filter(record => {
                    const fields = record.fields;
                    for (const key in fields) {
                        const value = fields[key];
                        if (value !== null && value !== undefined) {
                            if (String(value).toLowerCase().includes(searchQuery)) {
                                return true;
                            }
                        }
                    }
                    return false;
                });
            }
            if (statusFilter) {
                filteredMachines = filteredMachines.filter(record => record.fields['Machine Status'] === statusFilter);
            }
            renderMachineCards(filteredMachines, 'machines-container');
            
            // Filter and sort consumables within the modal if it's open
            if (!document.getElementById('consumables-modal').classList.contains('hidden')) {
                let filteredConsumables = currentModalConsumables;
                if (consumableSearchQuery) {
                    filteredConsumables = filteredConsumables.filter(record => {
                        const fields = record.fields;
                        for (const key in fields) {
                            const value = fields[key];
                            if (value !== null && value !== undefined) {
                                if (String(value).toLowerCase().includes(consumableSearchQuery)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                }
                if (window.innerWidth >= 640) {
                    renderConsumableTable(filteredConsumables, 'modal-consumables-table-body');
                } else {
                    renderConsumableCardsMobile(filteredConsumables, 'consumables-card-view');
                }
            }
            
            // Filter maintenance logs within the modal if it's open
            if (!document.getElementById('maintenance-logs-modal').classList.contains('hidden')) {
                let filteredLogs = currentModalMaintenanceLogs;
                if (logSearchQuery) {
                     filteredLogs = filteredLogs.filter(record => {
                        const consumableName = record.fields['Consumable Part'] ? dataCache[record.fields['Consumable Part'][0]]?.Name || 'Unknown Consumable' : 'N/A';
                        return consumableName.toLowerCase().includes(logSearchQuery) || 
                               (record.fields['Next Service Due'] && record.fields['Next Service Due'].toLowerCase().includes(logSearchQuery));
                     });
                }
                renderMaintenanceLogs(filteredLogs, 'maintenance-logs-container');
            }
        }
        
        /**
         * Toggles the visibility of the mobile filter section.
         */
        function toggleMobileFilters() {
            const collapsibleContent = document.getElementById('collapsible-filter-content');
            const toggleBtn = document.getElementById('toggle-filters-btn');
            const isExpanded = collapsibleContent.classList.toggle('expanded');
            if (isExpanded) {
                toggleBtn.textContent = 'Hide Filters';
            } else {
                toggleBtn.textContent = 'Show Filters';
            }
        }

        /**
         * Expands all machine cards.
         */
        function expandAllCards() {
            expandedCards = new Set(machinesData.map(record => record.id));
            localStorage.setItem('expandedCards', JSON.stringify([...expandedCards]));
            filterAndRender();
        }

        /**
         * Collapses all machine cards.
         */
        function collapseAllCards() {
            expandedCards.clear();
            localStorage.setItem('expandedCards', JSON.stringify([...expandedCards]));
            filterAndRender();
        }
        
        /**
         * Function to load more machine cards (for simulated lazy loading).
         */
        function loadMoreMachines() {
            machinesToRenderCount += 10;
            filterAndRender();
        }


        // Main function to initialize the application
        async function initApp() {
            const machinesContainer = document.getElementById('machines-container');
            if (machinesContainer) {
                 machinesContainer.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-10">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-gray-500">Loading Machines...</p>
                    </div>
                `;
            }

            const [machines, consumables, maintenanceLogs] = await Promise.all([
                fetchAirtableData('Machines'),
                fetchAirtableData('BSV 100 Consumables'),
                fetchAirtableData('BSV Maintenance Logs')
            ]);
            
            machines.sort((a, b) => {
                const machineIdA = a.fields['Machine ID'];
                const machineIdB = b.fields['Machine ID'];
                if (!machineIdA || !machineIdB) return 0;
                const numA = parseInt(machineIdA.split('-')[1]);
                const numB = parseInt(machineIdB.split('-')[1]);
                return numA - numB;
            });
            
            consumables.sort((a, b) => {
                const nameA = a.fields['Name'] || '';
                const nameB = b.fields['Name'] || '';
                return nameA.localeCompare(nameB);
            });
            
            machinesData = machines;
            consumablesData = consumables;
            maintenanceLogsData = maintenanceLogs;

            // Load persistent state from localStorage
            const savedSearchQuery = localStorage.getItem('searchQuery') || '';
            const savedStatusFilter = localStorage.getItem('statusFilter') || '';
            const savedExpandedCards = localStorage.getItem('expandedCards');
            if (savedExpandedCards) {
                expandedCards = new Set(JSON.parse(savedExpandedCards));
            }

            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const statusFilterMobile = document.getElementById('status-filter-mobile');
            if (searchInput && statusFilter && statusFilterMobile) {
                searchInput.value = savedSearchQuery;
                statusFilter.value = savedStatusFilter;
                statusFilterMobile.value = savedStatusFilter;
            }
            
            // Back to top button listener
            const backToTopBtn = document.getElementById('back-to-top-btn');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });


            // Initial render
            filterAndRender();
            renderLowStockAlerts();

            // Event listeners
            if (searchInput) {
                searchInput.addEventListener('input', (event) => {
                    localStorage.setItem('searchQuery', event.target.value);
                    filterAndRender();
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', (event) => {
                    localStorage.setItem('statusFilter', event.target.value);
                    filterAndRender();
                });
            }
            
            if (statusFilterMobile) {
                statusFilterMobile.addEventListener('change', (event) => {
                    localStorage.setItem('statusFilter', event.target.value);
                    filterAndRender();
                });
            }

            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', loadMoreMachines);
            }
            
            const consumableSearchInput = document.getElementById('consumable-search-input');
            if (consumableSearchInput) {
                consumableSearchInput.addEventListener('input', () => {
                    filterAndRender();
                });
            }
            
            const logSearchInput = document.getElementById('maintenance-log-search-input');
            if (logSearchInput) {
                 logSearchInput.addEventListener('input', () => {
                    filterAndRender();
                });
            }
            
            const closeConsumablesModalBtn = document.getElementById('close-consumables-modal-btn');
            if (closeConsumablesModalBtn) {
                closeConsumablesModalBtn.addEventListener('click', hideConsumablesModal);
            }
            
            const closeMaintenanceLogsModalBtn = document.getElementById('close-maintenance-logs-modal-btn');
            if (closeMaintenanceLogsModalBtn) {
                closeMaintenanceLogsModalBtn.addEventListener('click', hideMaintenanceLogsModal);
            }
            
            const consumablesModalBackdrop = document.getElementById('consumables-modal');
            if (consumablesModalBackdrop) {
                 consumablesModalBackdrop.addEventListener('click', (e) => {
                    if (e.target.id === 'consumables-modal') {
                        hideConsumablesModal();
                    }
                });
            }
            
            const maintenanceLogsModalBackdrop = document.getElementById('maintenance-logs-modal');
             if (maintenanceLogsModalBackdrop) {
                 maintenanceLogsModalBackdrop.addEventListener('click', (e) => {
                    if (e.target.id === 'maintenance-logs-modal') {
                        hideMaintenanceLogsModal();
                    }
                });
            }
            
            const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
            if (toggleFiltersBtn) {
                toggleFiltersBtn.addEventListener('click', toggleMobileFilters);
            }

            // New event listeners for expand/collapse all buttons
            const expandAllBtn = document.getElementById('expand-all-btn');
            if (expandAllBtn) {
                expandAllBtn.addEventListener('click', expandAllCards);
            }

            const collapseAllBtn = document.getElementById('collapse-all-btn');
            if (collapseAllBtn) {
                collapseAllBtn.addEventListener('click', collapseAllCards);
            }
            
            // Handle window resize for dynamic UI updates
            window.addEventListener('resize', filterAndRender);
        }

        window.onload = initApp;

    </script>
</body>
</html>
