<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #000;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal backdrop styling */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        /* Modal content styling */
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
        }
        .collapsible-content.expanded {
            max-height: 500px; /* A value larger than the max height to allow for expansion */
            padding-top: 1rem;
        }
        .collapsible-header .chevron {
            transition: transform 0.3s ease;
        }
        .collapsible-header.expanded .chevron {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-8">

    <!-- Header Section -->
    <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-2">Airtable Viewer</h1>
        <p class="text-lg text-gray-600">Viewing Data from Airtable</p>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto space-y-12">
        
        <!-- Search Bar -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <input type="search" id="search-input" placeholder="Search by Machine ID, Part Number, or Name..."
                   class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Machines Section -->
        <section class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Machines</h2>
            <div id="machines-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Loading spinner for machines -->
                <div class="col-span-full flex flex-col items-center justify-center py-10">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-500">Loading Machines...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Consumables Modal -->
    <div id="consumables-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-3xl font-bold text-gray-900">Consumables</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="modal-consumables-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Consumable cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Airtable configuration
        const airtableConfig = {
            apiKey: 'patA8WihRZtwXarV8.d6d00c7b162757fb1b30efe56d8b58f8dbbbbb9f058e52a22fcde00e566b9956', 
            baseId: 'appOKqcWBsHytL5Ae', 
        };
        const BASE_URL = `https://api.airtable.com/v0/${airtableConfig.baseId}/`;
        
        let dataCache = {};
        let machinesData = [];
        let consumablesData = [];

        // Utility function to fetch data from a table with exponential backoff
        async function fetchAirtableData(tableName, retries = 3, delay = 1000) {
            try {
                const response = await fetch(`${BASE_URL}${encodeURIComponent(tableName)}`, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Cache the data for quick lookups
                data.records.forEach(record => {
                    dataCache[record.id] = record.fields;
                });

                return data.records;

            } catch (error) {
                if (retries > 0 && error.message.includes('status: 429')) {
                    console.warn(`Rate limit hit for ${tableName}. Retrying in ${delay / 1000}s...`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchAirtableData(tableName, retries - 1, delay * 2); // Exponential backoff
                }
                console.error(`Could not fetch data from ${tableName}:`, error);
                const container = document.getElementById(getContainerId(tableName));
                if (container) {
                     container.innerHTML = `<p class="text-red-500 col-span-full text-center">Failed to load data for **${tableName}**. Please check the API key, table name, and network connection.</p>`;
                }
                return [];
            }
        }

        function getContainerId(tableName) {
            if (tableName === 'Machines') return 'machines-container';
            if (tableName === 'BSV 100 Consumables') return 'modal-consumables-container';
            return '';
        }

        /**
         * Toggles the expanded state of a collapsible card.
         * @param {string} recordId - The ID of the record to toggle.
         * @param {object} event - The click event object.
         */
        function toggleCardCollapse(event, recordId) {
            // Prevent the event from bubbling up and closing the card when a link is clicked
            if (event.target.tagName === 'A') {
                return;
            }

            const card = document.getElementById(`card-${recordId}`);
            if (!card) return;

            const collapsibleContent = card.querySelector('.collapsible-content');
            const collapsibleHeader = card.querySelector('.collapsible-header');

            if (collapsibleContent && collapsibleHeader) {
                const isExpanded = collapsibleContent.classList.toggle('expanded');
                collapsibleHeader.classList.toggle('expanded', isExpanded);
            }
        }

        /**
         * Renders the cards for a given list of records.
         * @param {Array} records - The list of Airtable records to render.
         * @param {string} containerId - The ID of the HTML element to render the cards in.
         * @param {string} titleFieldName - The name of the field to use as the card title.
         * @param {Array} fieldsToSkip - An array of field names to exclude from the card body.
         * @param {string} tableType - A string to identify the type of table ('Machines' or 'Consumables').
         */
        function renderCards(records, containerId, titleFieldName, fieldsToSkip = [], tableType) {
            const container = document.getElementById(containerId);
            if (!container) return; // Guard against non-existent containers
            container.innerHTML = '';
            if (records.length === 0) {
                container.innerHTML = `<p class="text-gray-500 col-span-full text-center">No records found.</p>`;
                return;
            }
            
            // Define the preferred display order for fields
            const machineFieldOrder = [
                'Manufacturer', 'Model', 'Serial Number', 'Part Number', 
                'Equipment Number', 'Year', 'Consumables', 'Machine Status',
                'Last Service Date', 'Next Service Due'
            ];
            
            // Updated consumable field order as per user request
            const consumableFieldOrder = [
                'Cost/Unit', 'Unit', 'Supplier', 'Location', 'Reorder Point', 
                'Current Stock', 'Stock Status'
            ];

            records.forEach(record => {
                const fields = record.fields;
                const card = document.createElement('div');
                card.id = `card-${record.id}`;
                card.className = 'bg-gray-50 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 flex flex-col cursor-pointer';
                
                let cardHtml = '';
                const cardTitle = fields[titleFieldName];
                const renderedFields = new Set();
                let orderedFieldsToRender = [];

                if (tableType === 'Machines') {
                    orderedFieldsToRender = machineFieldOrder;
                    card.onclick = (event) => toggleCardCollapse(event, record.id);
                    
                    // Header for collapsible card
                    cardHtml += `
                        <div class="collapsible-header flex justify-between items-center pb-2">
                            <h3 class="text-xl font-medium text-gray-900">${cardTitle || 'Untitled Machine'}</h3>
                            <i class="fas fa-chevron-down text-gray-500 chevron"></i>
                        </div>
                        <div class="collapsible-content mt-2">
                    `;
                    renderedFields.add(titleFieldName); // Title is already handled
                } else if (tableType === 'Consumables') {
                    orderedFieldsToRender = consumableFieldOrder;
                    cardHtml += `<h3 class="text-xl font-medium text-gray-900 mb-2">${cardTitle || 'Untitled Consumable'}</h3>`;
                    renderedFields.add(titleFieldName);
                }

                orderedFieldsToRender.forEach(fieldName => {
                    let fieldValue = fields[fieldName];
                    
                    // Handle special case for 'Next Service Due'
                    if (fieldName === 'Next Service Due' && !fieldValue) {
                        fieldValue = 'N/A';
                    }

                    // Skip if the field is not present or if it's in the skip list.
                    if (fieldsToSkip.includes(fieldName)) {
                        return;
                    }

                    renderedFields.add(fieldName);
                    
                    if (fieldName === 'Consumables' && tableType === 'Machines') {
                        // This is the correct place to handle the "View Consumables" link.
                        cardHtml += `<p class="text-gray-600"><span class="font-semibold">${fieldName}:</span> <a href="#" class="text-blue-600 hover:underline" onclick="displayConsumablesForMachine('${record.id}'); return false;">View Consumables</a></p>`;
                    } else if (fieldName === 'Cost/Unit' && typeof fieldValue === 'number') {
                        let displayValue = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD'
                        }).format(fieldValue);
                        cardHtml += `<p class="text-gray-600"><span class="font-semibold">${fieldName}:</span> ${displayValue}</p>`;
                    } else if (Array.isArray(fieldValue) && fieldValue.every(v => typeof v === 'string' && v.startsWith('rec'))) {
                        const linkedNames = fieldValue.map(id => {
                            const linkedRecord = dataCache[id];
                            return linkedRecord ? (linkedRecord['Name'] || linkedRecord['Part Number'] || id) : id;
                        }).join(', ');
                        cardHtml += `<p class="text-gray-600"><span class="font-semibold">${fieldName}:</span> ${linkedNames}</p>`;
                    } else if (Array.isArray(fieldValue)) {
                        let displayValue = fieldValue.join(', ');
                        cardHtml += `<p class="text-gray-600"><span class="font-semibold">${fieldName}:</span> ${displayValue}</p>`;
                    } else {
                        cardHtml += `<p class="text-gray-600"><span class="font-semibold">${fieldName}:</span> ${fieldValue || 'N/A'}</p>`;
                    }
                });
                
                // Only loop through all remaining fields for the 'Machines' table to avoid extra fields on 'Consumables'
                if (tableType === 'Machines') {
                    for (const fieldName in fields) {
                        if (fields.hasOwnProperty(fieldName) && !renderedFields.has(fieldName) && !fieldsToSkip.includes(fieldName)) {
                            let fieldValue = fields[fieldName];

                            // Special case for 'Next Service Due' in the fallback
                            if (fieldName === 'Next Service Due' && !fieldValue) {
                                fieldValue = 'N/A';
                            }
                            
                            if (fieldValue) {
                                let displayValue = fieldValue;
                                if (Array.isArray(fieldValue) && fieldValue.every(v => typeof v === 'string' && v.startsWith('rec'))) {
                                    const linkedNames = fieldValue.map(id => {
                                        const linkedRecord = dataCache[id];
                                        return linkedRecord ? (linkedRecord['Name'] || linkedRecord['Part Number'] || id) : id;
                                    }).join(', ');
                                    displayValue = linkedNames;
                                } else if (Array.isArray(fieldValue)) {
                                    displayValue = fieldValue.join(', ');
                                }
                                cardHtml += `<p class="text-gray-600"><span class="font-semibold">${fieldName}:</span> ${displayValue}</p>`;
                            }
                        }
                    }
                    cardHtml += `</div>`; // Close collapsible content div
                }
                
                if (cardHtml) {
                    card.innerHTML = cardHtml;
                } else {
                    card.innerHTML = `<p class="text-gray-500">No data available for this record.</p>`;
                }
                
                container.appendChild(card);
            });
        }
        
        /**
         * Shows the modal with the given title and content.
         * @param {string} title - The title for the modal.
         * @param {Array} records - The records to display in the modal.
         * @param {string} tableType - The type of table for rendering ('Consumables').
         */
        function showConsumablesModal(title, records, tableType) {
            const modal = document.getElementById('consumables-modal');
            const modalTitle = document.getElementById('modal-title');
            
            modalTitle.textContent = title;
            // Updated to use 'Name' as the title field for consumables
            renderCards(records, 'modal-consumables-container', 'Name', [], tableType);
            modal.classList.remove('hidden');
        }

        /**
         * Hides the modal.
         */
        function hideConsumablesModal() {
            const modal = document.getElementById('consumables-modal');
            modal.classList.add('hidden');
        }

        /**
         * Filters the consumables and displays them for a specific machine inside a modal.
         * @param {string} machineRecordId - The ID of the machine record.
         */
        function displayConsumablesForMachine(machineRecordId) {
            const machineRecord = dataCache[machineRecordId];
            if (!machineRecord || !machineRecord['Consumables']) {
                const consumablesContainer = document.getElementById('modal-consumables-container');
                if (consumablesContainer) {
                    consumablesContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">No consumables found for this machine.</p>`;
                }
                const title = `Consumables for ${machineRecord ? machineRecord['Machine ID'] + ' - ' + machineRecord['Name'] : 'Unknown Machine'}`;
                showConsumablesModal(title, [], 'Consumables');
                return;
            }
            
            const consumableIds = machineRecord['Consumables'];
            const filteredConsumables = consumablesData.filter(c => consumableIds.includes(c.id));
            
            const title = `Consumables for ${machineRecord['Machine ID']} - ${machineRecord['Name']}`;
            showConsumablesModal(title, filteredConsumables, 'Consumables');
        }
        
        /**
         * Function to handle filtering based on search input
         * It searches across all fields of the machine records.
         */
        function filterRecords(records, query) {
            if (!query) {
                return records;
            }

            const lowerCaseQuery = query.toLowerCase();

            return records.filter(record => {
                const fields = record.fields;
                for (const fieldName in fields) {
                    const fieldValue = fields[fieldName];

                    // Handle linked records and other arrays
                    if (Array.isArray(fieldValue)) {
                        let displayValue = '';
                        if (fieldValue.every(v => typeof v === 'string' && v.startsWith('rec'))) {
                            const linkedNames = fieldValue.map(id => {
                                const linkedRecord = dataCache[id];
                                return linkedRecord ? (linkedRecord['Name'] || linkedRecord['Part Number'] || id) : id;
                            }).join(', ');
                            displayValue = linkedNames;
                        } else {
                            displayValue = fieldValue.join(', ');
                        }
                        if (displayValue.toLowerCase().includes(lowerCaseQuery)) {
                            return true;
                        }
                    } 
                    // Handle text fields and numbers as strings
                    else if (typeof fieldValue === 'string' || typeof fieldValue === 'number') {
                        if (String(fieldValue).toLowerCase().includes(lowerCaseQuery)) {
                            return true;
                        }
                    }
                }
                return false;
            });
        }

        // Main function to initialize the application
        async function initApp() {
            // Display loading spinners while data is being fetched
            const machinesContainer = document.getElementById('machines-container');
            if (machinesContainer) {
                 machinesContainer.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-10">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-gray-500">Loading Machines...</p>
                    </div>
                `;
            }

            const [machines, consumables] = await Promise.all([
                fetchAirtableData('Machines'),
                fetchAirtableData('BSV 100 Consumables')
            ]);
            
            // Sort machines by Machine ID
            machines.sort((a, b) => {
                const machineIdA = a.fields['Machine ID'];
                const machineIdB = b.fields['Machine ID'];
                if (!machineIdA || !machineIdB) return 0;
                const numA = parseInt(machineIdA.split('-')[1]);
                const numB = parseInt(machineIdB.split('-')[1]);
                return numA - numB;
            });
            
            // Sort consumables by Name
            consumables.sort((a, b) => {
                const nameA = a.fields['Name'] || '';
                const nameB = b.fields['Name'] || '';
                return nameA.localeCompare(nameB);
            });
            
            machinesData = machines;
            consumablesData = consumables;
            
            // Initial render of machines
            renderCards(machinesData, 'machines-container', 'Machine ID', [], 'Machines');

            // Event listeners
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (event) => {
                    const query = event.target.value;
                    const filteredMachines = filterRecords(machinesData, query);
                    renderCards(filteredMachines, 'machines-container', 'Machine ID', [], 'Machines');
                });
            }
            
            const closeModalBtn = document.getElementById('close-modal-btn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', hideConsumablesModal);
            }
            
            const modalBackdrop = document.getElementById('consumables-modal');
            if (modalBackdrop) {
                 modalBackdrop.addEventListener('click', (e) => {
                    // Close the modal only if the user clicks the backdrop, not the modal content
                    if (e.target.id === 'consumables-modal') {
                        hideConsumablesModal();
                    }
                });
            }
        }

        window.onload = initApp;

    </script>
</body>
</html>
